<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Карта турников Ишима</title>
  <link
          rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .legend {
      position: absolute; z-index: 1000; top: 10px; left: 10px;
      background: #fff; padding: 6px 7px 6px; border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.1);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      max-width: min(92vw, 380px);
    }
    .legend h1 { font-size: 12px; margin: 0 0 6px; }
    .popup h3 { margin: 0 8px 6px 0; font-size: 16px; display: inline-block; }
    .gallery { margin-top: 6px; }
    .gallery .main { width: 100%; max-width: 260px; border-radius: 10px; display: block; }
    .thumbs { display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; max-width: 260px; }
    .thumbs img { width: 56px; height: 56px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid transparent; }
    .thumbs img.active { border-color: #EF5350; }
    .meta { margin-top: 6px; color: #555; font-size: 13px; }

    /* Фильтры */
    #filters { margin-top: 6px; display: flex; gap: 8px; flex-wrap: wrap; }
    #filters label {
      display: inline-flex; align-items: center; gap: 6px;
      background: #f6f6f6; padding: 4px 8px; border-radius: 8px;
      border: 1px solid #e5e5e5; font-size: 12px; user-select: none;
    }
    #filters input[type="checkbox"] { transform: scale(1.05); }
    #filters .hint { font-size: 11px; color: #666; margin-top: 2px; width: 100%; }
  </style>
</head>
<body>
<div id="map"></div>

<div class="legend">
  <h1 id="legend-count"></h1>
  <h1 id="legend-date">Обновлено: 02.09.25 12:52</h1>
  <div id="filters"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
<script src="https://cdn.jsdelivr.net/gh/shramov/leaflet-plugins/layer/tile/Yandex.js"></script>

<script>
  const POINTS = [
    {
      name: "Площадка во дворе",
      coords: [56.103740, 69.458343],
      equipment: [
        { type: "Турник", height: 175 },
        { type: "Кольца", height: 150, width: 45 }
      ],
      surface: "Земля",
      photos: ["images/wo_msk25.jpg"]
    },
    {
      name: "Площадка во дворе",
      coords: [56.105535, 69.460074],
      equipment: [
        { type: "Турник", height: 200}
      ],
      surface: "Земля",
      photos: ["images/wo_lun46.jpg"]
    },
    {
      name: "Казачья молодежь Сибири",
      coords: [56.102327, 69.463071],
      equipment: [
        { type: "Турник" },
        { type: "Брусья", height: 120, width: 55 }
      ],
      surface: "Резина",
      photos: ["images/wo_kaz.jpg"],
      private: true
    },
    {
      name: "Во дворе Общежития",
      coords: [56.100884, 69.463845],
      equipment: [
        { type: "Турник" },
        { type: "Брусья" },
        { type: "Кольца" }
      ],
      surface: "Земля",
      photos: ["images/wo_ped_obsh.jpg"]
    },
    {
      name: "Площадка во дворе",
      coords: [56.109261, 69.496403],
      equipment: [
        { type: "Турник", height: 230 },
        { type: "Турник", height: 200 },
        { type: "Турник", height: 170 }
      ],
      surface: "Земля",
      photos: ["images/wo_shar7.jpg"]
    },
    {
      name: "СК Локомотив. С обратной стороны",
      coords: [56.105871, 69.501988],
      equipment: [
        { type: "Турник", height: 220 },
        { type: "Турник", height: 200 },
        { type: "Турник", height: 185 },
        { type: "Брусья", height: 130, width: 75 }
      ],
      surface: "Резина",
      photos: ["images/wo_loko.jpg"]
    },
    {
      name: "Бульвар Белоусова",
      coords: [56.133145, 69.535276],
      equipment: [
        { type: "Турник" },
        { type: "Брусья" },
      ],
      surface: "Резина",
      photos: ["images/wo_belous.jpg"]
    }
  ];

  // === Задаём границы города Ишим ===
  const CITY_BOUNDS = L.latLngBounds([56.00, 69.35], [56.20, 69.60]);

  // === КАРТА ===
  const map = L.map('map', {
    maxBounds: CITY_BOUNDS,
    maxBoundsViscosity: 1.0,
    minZoom: 13,
    attributionControl: false
  });

  const yandexScheme = L.yandex('yandex#map').addTo(map);
  const yandexSatellite = L.yandex('yandex#satellite');
  // const yandexHybrid = L.yandex('yandex#hybrid');

  L.control.layers(
          {
            'Яндекс: Схема': yandexScheme,
            'Яндекс: Спутник': yandexSatellite,
            // 'Яндекс: Гибрид': yandexHybrid
          },
          {},
          { collapsed: false }
  ).addTo(map);

  // Центрирование
  if (POINTS.length) {
    const ptsBounds = L.latLngBounds(POINTS.map(p => p.coords));
    const target = CITY_BOUNDS.contains(ptsBounds) ? ptsBounds : CITY_BOUNDS;
    map.fitBounds(target, { padding: [30, 30] });
  } else {
    map.setView([56.109175, 69.457073], 12);
  }

  // == Фильтры по типам ===
  function collectEquipmentTypes(points) {
    const set = new Set();
    points.forEach(p => (p.equipment || []).forEach(eq => {
      if (eq.type) set.add(eq.type.trim());
    }));
    return Array.from(set).sort((a,b)=>a.localeCompare(b, 'ru'));
  }

  function renderFilters(types) {
    const box = document.getElementById('filters');
    if (!box) return;
    if (!types.length) {
      box.innerHTML = '<div class="hint">Типы снарядов не найдены</div>';
      return;
    }
    const html = types.map(t => {
      const id = 'flt-' + t.replace(/\s+/g,'-');
      return `<label><input type="checkbox" value="${t}" id="${id}">${t}</label>`;
    }).join('');
    box.innerHTML = html;

    // Делегируем обработчик кликов
    box.addEventListener('change', () => renderMarkers());
  }

  function getSelectedTypes() {
    const inputs = document.querySelectorAll('#filters input[type="checkbox"]:checked');
    return Array.from(inputs).map(i => i.value);
  }

  // === Маркеры + попапы ===
  const markersLayer = L.layerGroup().addTo(map);

  function renderMarkers() {
    const selected = getSelectedTypes(); // если [], показываем все
    markersLayer.clearLayers();

    POINTS.forEach((p, idx) => {
      if (!CITY_BOUNDS.contains(p.coords)) return;

      // Фильтрация: если выбран хотя бы один тип, у точки должен быть пересекающийся тип
      if (selected.length) {
        const typesHere = (p.equipment || []).map(eq => (eq.type || '').trim());
        if (!typesHere.some(t => selected.includes(t))) return;
      }

      const m = L.circleMarker(p.coords, {
        radius: 8,
        color: "#333",
        weight: 2,
        fillColor: "#EF5350",
        fillOpacity: 0.9
      });

      let equipmentList = "—";
      if (p.equipment && p.equipment.length) {
        equipmentList = p.equipment.map(eq => {
          const params = [];
          if (eq.height) params.push(`↕:${eq.height}`);
          if (eq.width)  params.push(`↔:${eq.width}`);
          const paramText = params.length ? ` (${params.join(", ")})` : "";
          return `· ${eq.type}${paramText}`;
        }).join("<br>");
      }

      let galleryHtml = "";
      if (p.photos && p.photos.length) {
        const main = p.photos[0];
        const thumbs = p.photos.map((src, i) =>
                `<img loading="lazy" src="${src}" data-thumb data-index="${i}" alt="Фото ${i+1}" class="${i===0?"active":""}">`
        ).join("");
        galleryHtml = `
            <div class="gallery" data-gallery="${idx}">
              <img loading="lazy" src="${main}" alt="Фото площадки" class="main" data-main>
              ${p.photos.length > 1 ? `<div class="thumbs">${thumbs}</div>` : ""}
            </div>
          `;
      }

      const privateHtml = p.private
              ? `<div style="margin:8px 0;padding:6px 10px;background:#ffebee;border:1px solid #c62828;border-radius:8px;color:#b71c1c;font-weight:600;">
               Доступ к площадке может быть ограничен
             </div>`
              : "";

      const surfaceHtml = p.surface
              ? `<div class="meta" style="margin-top:6px;"><b>Покрытие:</b> ${p.surface}</div>`
              : "";

      m.bindPopup(`
          <div class="popup">
            <h3>${p.name}</h3>
            ${privateHtml}
            ${galleryHtml}
            <div class="meta" style="margin-top:${galleryHtml ? "8px" : "0"}">
              ${equipmentList}
            </div>
            ${surfaceHtml}
          </div>
        `);

      m.addTo(markersLayer);
    });
  }

  // Галерея: клик по миниатюрам
  map.on('popupopen', (e) => {
    const root = e.popup.getElement();
    if (!root) return;
    const mainImg = root.querySelector('[data-main]');
    const thumbs = root.querySelectorAll('[data-thumb]');
    if (!mainImg || !thumbs.length) return;

    thumbs.forEach(t => {
      t.addEventListener('click', () => {
        const src = t.getAttribute('src');
        if (!src) return;
        mainImg.setAttribute('src', src);
        thumbs.forEach(x => x.classList.remove('active'));
        t.classList.add('active');
      });
    });
  });

  // Геолокация
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const ll = [pos.coords.latitude, pos.coords.longitude];
      if (CITY_BOUNDS.contains(ll)) {
        L.circleMarker(ll, { radius: 6 }).addTo(map).bindPopup('Вы здесь');
      }
    });
  }

  // Легенда: количество площадок
  const countEl = document.getElementById("legend-count");
  if (countEl) {
    countEl.textContent = `Площадок: ${POINTS.length}`;
  }

  // Инициализация фильтров и первичная отрисовка
  const TYPES = collectEquipmentTypes(POINTS);
  renderFilters(TYPES);
  renderMarkers();
</script>
</body>
</html>
